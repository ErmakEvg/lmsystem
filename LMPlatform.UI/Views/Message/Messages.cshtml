@using Application.Core.UI.HtmlHelpers
@using LMPlatform.UI.Controllers

@{
    ViewBag.Title = "Сообщения";
}
@section css
{
    <link rel="stylesheet" href="/Content/chosen/chosen.css">

}
@section scripts
{
    @Scripts.Render("~/bundles/datatable")
    <script src="/Scripts/chosen/chosen.jquery.js" type="text/javascript"></script>
    <script src="/Scripts/chosen/ajax-chosen.js" type="text/javascript"></script>

    <script src="/Scripts/angular.js" type="text/javascript"></script>
    <script src="/Scripts/ng-table.js" type="text/javascript"></script>
    <script src="/Scripts/application/msgModule.js" type="text/javascript"></script>
}

<style type="text/css">
    .nav a {
        cursor: pointer;
    }

    .bordered {
        border-bottom: #ddd solid 1px;
    }

    .ellipsis {
        overflow: hidden;
        -moz-text-overflow: ellipsis;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .msg-row {
        height: 45px;
        cursor: pointer;
    }

        .msg-row i.is-read {
            color: #008cba;
        }

        .msg-row .fa-envelope {
            color: gray;
        }

        .msg-row td:first-child {
            width: 60px;
            -moz-min-width: 60px;
            -ms-min-width: 60px;
            -o-min-width: 60px;
            -webkit-min-width: 60px;
            min-width: 60px;
        }

    sub.paperclip {
        font-size: 11px;
        top: 12px;
        padding-left: -15px;
        margin-left: -5px;
        color: gray;
    }

    .msg-row .athor-name {
        font-size: 17px;
        max-width: 250px;
        min-width: 250px;
        width: 250px;
        line-height: 40px;
        overflow: hidden;
        padding: 0 10px 0 0;
    }

    .msg-row .recip-name {
        width: 180px;
        max-width: 180px;
        float: left;
    }

    .msg-row .recip-name-add {
        width: 70px;
        max-width: 70px;
        min-width: 70px;
        color: #008cba;
        text-decoration: none;
    }

    .msg-row .subject {
        font-size: 15px;
        color: #515151;
        padding-left: 10px;
        max-width: 140px;
        overflow: hidden;
        -moz-text-overflow: ellipsis;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .msg-row .preview-text {
        font-size: 15px;
        color: #515151;
        overflow: hidden;
        -moz-text-overflow: ellipsis;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 180px;
        padding-left: 10px;
    }

    .msg-row .date {
        text-align: right;
        font-size: 16px;
        max-width: 85px;
        width: 85px;
        padding-left: 10px;
    }

    .msg-row .delete-button {
        width: 45px;
        text-align: right;
    }

    #buttonActionSection {
        margin: 20px 0;
        padding-left: 10px;
    }

    .tab-content-wrapper {
        margin-left: 172px;
        border-left: #ddd 1px solid;
        padding-left: 35px;
        min-height: 150px;
    }

    .ng-table-pager {
        padding-top: 20px;
    }

    .row {
        padding: 0 10px;
    }

    .display-msg {
    }

        .display-msg .msg-body {
            border: solid #ddd 1px;
            padding: 10px;
            margin: 10px 0 10px 0;
            word-wrap: break-word;
        }

        .display-msg .author-name {
            font-size: 22px;
            padding: 5px 0 10px 0;
        }

        .display-msg label {
            color: gray;
            font-size: 15px;
            padding-right: 10px;
        }

        .display-msg .recip-name .fa {
            color: #D1D1D1;
            margin: 0 3px 0 10px;
            font-size: 13px;
        }

        .display-msg .attach-link {
            padding-right: 15px;
        }

            .display-msg .attach-link .glyphicon {
                margin-right: 3px;
            }
</style>
@section navleft
{
    <li>
        <a href="@(Request.UrlReferrer != null && !string.IsNullOrEmpty(Request.UrlReferrer.ToString()) ? Request.UrlReferrer.ToString() : "/")" style="font-size: 17px">
            <i class="fa fa-reply fa-1x fa-tab"></i>Вернуться
        </a>
    </li>
}

<div ng-app="msgApp" ng-controller="msgController" ng-init="init(@WebSecurity.CurrentUserId)">

    <h3>Сообщения</h3>
    <hr>
    <div>
        <div id="buttonActionSection">
            <a href="#" class="msg-send msgButton btn btn-primary btn-sm" data-url="@Url.Action("WriteMessage", "Message")" data-toggle="tooltip">Написать</a>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 tabbable tabs-left">
            <ul class="nav nav-tabs" style="width: 173px">
                <li ng-class="{'active': activeTab === 'inbox'}">
                    <a ng-click="switchTabTo('inbox')">Входящие ({{inboxMessages.length}})</a>
                </li>
                <li ng-class="{'active': activeTab === 'outbox'}">
                    <a ng-click="switchTabTo('outbox')">Отправленные ({{outboxMessages.length}})</a>
                </li>
            </ul>
            <div class="tab-content-wrapper">
                <div class="tab-content" style="width: 100%">
                    <table ng-table="tableParams" style="width: 100%">
                        <tbody>
                            <tr class="msg-row" ng-repeat="msg in $data">
                                <td ng-click="show(msg)">
                                    <i ng-class="{'is-read': !msg.IsRead && activeTab === 'inbox'}" class="fa fa-2x  fa-envelope"></i>
                                    <sub class="paperclip" ng-if="msg.AttachmentsCount > 0">
                                        <span>
                                            <i class="glyphicon glyphicon-paperclip"></i>
                                            {{msg.AttachmentsCount}}
                                        </span>
                                    </sub>
                                </td>
                                <td ng-click="show(msg)" class="athor-name bordered ellipsis">
                                    <span ng-if="activeTab === 'inbox'">{{msg.AthorName}}
                                    </span>
                                    <span ng-if="activeTab === 'outbox'">
                                        <span class="recip-name ellipsis">{{msg.Recipients[0]}}</span>
                                        <span class="recip-name-add" ng-if="msg.Recipients.length > 1">+ ещё {{msg.Recipients.length - 1}}</span>
                                    </span>
                                </td>
                                <td ng-click="show(msg)" class="subject bordered">{{msg.Subject}}
                                </td>
                                <td ng-click="show(msg)" class="preview-text bordered">{{msg.PreviewText}}
                                </td>
                                <td ng-click="show(msg)" class="date bordered">{{msg.Date}}
                                </td>
                                <td class="delete-button">
                                    <a href="#" ng-click="deleteMessage(msg.Id)" title="Удалить">
                                        <span class="fa fa-trash-o fa-2x" />
                                    </a>
                                </td>

                            </tr>
                        </tbody>
                    </table>
                    <div style="display: none">
                        <display-message>
                        </display-message>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
